<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tripper</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Frutiger Linotype", Frutiger, "Dejavu Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: #fff;
      color: #333;
      line-height: 1.5;
      font-size: 14px;
    }

    /* ---------- Header bar ---------- */
    .header {
      background: linear-gradient(to bottom, #f5f5f5, #e8e8e8);
      border-bottom: 1px solid #ccc;
      padding: 12px 0;
    }
    .header-inner {
      max-width: 760px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-decoration: none;
    }
    .logo-tr { color: #0891b2; }
    .logo-ipper { color: #ff0084; }
    .beta {
      display: inline-block;
      background: #ff0084;
      color: #fff;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 1px 5px;
      border-radius: 3px;
      margin-left: 5px;
      vertical-align: super;
      letter-spacing: 0.5px;
    }

    .header-tagline {
      color: #888;
      font-size: 12px;
    }

    /* ---------- Main content ---------- */
    .main {
      max-width: 760px;
      margin: 0 auto;
      padding: 28px 20px;
    }

    .page-desc {
      color: #666;
      font-size: 13px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #eee;
    }

    /* ---------- Dependency warning ---------- */
    .dep-warning {
      background: #fff8e1;
      border: 1px solid #ffe082;
      border-radius: 4px;
      padding: 10px 14px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #6d4c00;
    }
    .dep-warning strong { color: #e65100; }
    .dep-warning code {
      background: #fff3c4;
      padding: 1px 5px;
      border-radius: 2px;
      font-family: "Lucida Console", Monaco, monospace;
      font-size: 12px;
    }

    /* ---------- Form card ---------- */
    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .card-header {
      background: linear-gradient(to bottom, #fafafa, #f0f0f0);
      border-bottom: 1px solid #ddd;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 700;
      color: #555;
    }
    .card-body {
      padding: 16px;
    }

    /* ---------- Form elements ---------- */
    label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: #555;
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .helper {
      font-size: 11px;
      color: #999;
      margin-top: 6px;
      margin-bottom: 0;
      text-transform: none;
      font-weight: 400;
      letter-spacing: 0;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #bbb;
      border-radius: 3px;
      font-size: 14px;
      font-family: inherit;
      margin-bottom: 14px;
      background: #fff;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #0891b2;
      box-shadow: 0 0 0 2px rgba(0,99,220,0.15);
    }

    .form-row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-bottom: 14px;
    }
    .form-row > div { flex: 1; }

    .slider-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="range"] {
      flex: 1;
      accent-color: #0891b2;
      height: 4px;
    }

    .slider-val {
      font-weight: 700;
      font-size: 14px;
      color: #0891b2;
      min-width: 36px;
      text-align: center;
      font-family: "Lucida Console", Monaco, monospace;
    }

    select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #bbb;
      border-radius: 3px;
      font-size: 13px;
      font-family: inherit;
      background: #fff;
    }

    .model-hint {
      font-size: 11px;
      color: #999;
      margin-top: 3px;
    }

    /* ---------- Toggle switch (Flickr-style) ---------- */
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }
    .toggle-row label {
      text-transform: none;
      font-size: 13px;
      font-weight: 400;
      color: #333;
      margin-bottom: 0;
      letter-spacing: 0;
    }

    .switch {
      position: relative;
      width: 36px;
      height: 20px;
      flex-shrink: 0;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .switch .track {
      position: absolute;
      inset: 0;
      background: #ccc;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .switch .track::after {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      left: 3px;
      top: 3px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .switch input:checked + .track { background: #0891b2; }
    .switch input:checked + .track::after { transform: translateX(16px); }

    .slide-options { transition: opacity 0.2s; }
    .slide-options.disabled { opacity: 0.3; pointer-events: none; }

    /* ---------- Buttons ---------- */
    .btn-go {
      display: block;
      width: 100%;
      padding: 10px;
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      color: #fff;
      cursor: pointer;
      border: 1px solid #cc006a;
      border-radius: 4px;
      background: linear-gradient(to bottom, #ff1a95, #e0006f);
      text-shadow: 0 1px 1px rgba(0,0,0,0.2);
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      transition: all 0.15s;
    }
    .btn-go:hover:not(:disabled) {
      background: linear-gradient(to bottom, #ff3da5, #ff0084);
    }
    .btn-go:active:not(:disabled) {
      background: linear-gradient(to bottom, #cc006a, #b80060);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    .btn-go:disabled { opacity: 0.45; cursor: not-allowed; }

    .btn-secondary {
      display: inline-block;
      padding: 6px 16px;
      font-size: 12px;
      font-weight: 700;
      font-family: inherit;
      color: #333;
      cursor: pointer;
      border: 1px solid #bbb;
      border-radius: 3px;
      background: linear-gradient(to bottom, #fff, #eee);
      text-decoration: none;
    }
    .btn-secondary:hover {
      background: linear-gradient(to bottom, #fff, #e0e0e0);
      border-color: #999;
    }

    /* ---------- Progress ---------- */
    .progress-section {
      display: none;
    }
    .progress-section.visible { display: block; }

    .progress-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 700;
      color: #555;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #ddd;
      border-top-color: #0891b2;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .spinner.done { display: none; }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .check { display: none; color: #39a845; font-weight: 700; font-size: 14px; }
    .check.done { display: inline; }

    .progress-log {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 10px 12px;
      font-family: "Lucida Console", Monaco, "Courier New", monospace;
      font-size: 11px;
      max-height: 180px;
      overflow-y: auto;
      color: #666;
    }
    .progress-log .log-line { padding: 2px 0; }
    .progress-log .log-error { color: #d32f2f; font-weight: 700; }
    .progress-log .log-done { color: #39a845; font-weight: 700; }

    /* ---------- Output ---------- */
    .output-section {
      display: none;
    }
    .output-section.visible { display: block; }

    .transcript-area {
      width: 100%;
      min-height: 280px;
      max-height: 460px;
      overflow-y: auto;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 14px;
      font-family: "Lucida Console", Monaco, "Courier New", monospace;
      font-size: 12px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-bottom: 12px;
    }

    .transcript-area .slide-marker {
      display: block;
      color: #ff0084;
      font-weight: 700;
      margin: 0.5em 0 0.15em;
    }

    .output-actions {
      display: flex;
      gap: 8px;
    }

    /* ---------- Footer ---------- */
    .footer {
      max-width: 760px;
      margin: 0 auto;
      padding: 20px 20px 40px;
      border-top: 1px solid #eee;
      font-size: 11px;
      color: #aaa;
    }
    .footer a { color: #0891b2; text-decoration: none; }
    .footer a:hover { text-decoration: underline; }

    /* ---------- Toast ---------- */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 8px 16px;
      border-radius: 3px;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="header-inner">
      <div>
        <span class="logo"><span class="logo-tr">Tr</span><span class="logo-ipper">ipper</span></span>
        <span class="beta">beta</span>
      </div>
      <span class="header-tagline">TRanscript rIPPER</span>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <p class="page-desc">
      Paste a YouTube or Instagram Reel URL. Tripper downloads the video, transcribes the audio with Whisper,
      optionally detects slide transitions, and gives you a clean timestamped transcript.
    </p>

    {% if missing_deps %}
    <div class="dep-warning">
      <strong>Missing dependencies:</strong>
      {% for dep in missing_deps %}
        <code>{{ dep }}</code>{% if not loop.last %}, {% endif %}
      {% endfor %}
      <br>Install them and restart. These must be available on your system PATH.
    </div>
    {% endif %}

    <!-- Input card -->
    <div class="card">
      <div class="card-header">New Transcript</div>
      <div class="card-body">
        <label for="url">Video URL</label>
        <input type="text" id="url" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off">

        <div class="toggle-row">
          <label class="switch">
            <input type="checkbox" id="slide-detect" checked>
            <span class="track"></span>
          </label>
          <label for="slide-detect">Detect slide changes</label>
        </div>

        <div class="slide-options" id="slide-options">
          <div class="form-row">
            <div>
              <label for="threshold">Sensitivity</label>
              <div class="slider-wrap">
                <input type="range" id="threshold" min="0.1" max="0.8" step="0.05" value="0.3">
                <span class="slider-val" id="threshold-val">0.30</span>
              </div>
              <div class="helper">Controls how easily a "slide change" is detected. Lower values catch more changes but may flag speaker movements as slides. Higher values only catch big visual shifts. Start at 0.3 and raise it if you're getting too many false markers.</div>
            </div>
            <div>
              <label for="model">Whisper Model</label>
              <select id="model">
                <option value="tiny">tiny</option>
                <option value="small">small</option>
                <option value="medium" selected>medium (recommended)</option>
                <option value="large">large</option>
              </select>
              <div class="model-hint" id="model-hint">~2-5 min for a 45-min talk</div>
              <div class="helper">The AI model that converts speech to text. Smaller models are faster but less accurate. Larger models take longer but catch more words correctly &mdash; especially names, jargon, and quiet speech.</div>
            </div>
          </div>
        </div>

        <button class="btn-go" id="btn-start" {% if missing_deps %}disabled{% endif %}>RIP IT</button>
      </div>
    </div>

    <!-- Progress card -->
    <div class="progress-section" id="progress-section">
      <div class="card">
        <div class="card-header">Progress</div>
        <div class="card-body">
          <div class="progress-header">
            <div class="spinner" id="spinner"></div>
            <span class="check" id="check-mark">&#10003;</span>
            <span id="progress-label">Processing...</span>
          </div>
          <div class="progress-log" id="progress-log"></div>
        </div>
      </div>
    </div>

    <!-- Output card -->
    <div class="output-section" id="output-section">
      <div class="card">
        <div class="card-header">Transcript</div>
        <div class="card-body">
          <div class="transcript-area" id="transcript-area"></div>
          <div class="output-actions">
            <button class="btn-secondary" id="btn-download">Download .txt</button>
            <button class="btn-secondary" id="btn-copy">Copy to clipboard</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Tripper &mdash; a local transcript ripper. Powered by
    <a href="https://github.com/openai/whisper" target="_blank">Whisper</a>,
    <a href="https://github.com/yt-dlp/yt-dlp" target="_blank">yt-dlp</a> &amp;
    <a href="https://ffmpeg.org" target="_blank">ffmpeg</a>.
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const modelHints = {
      tiny:   "~30 sec for a 45-min talk (least accurate)",
      small:  "~1-2 min for a 45-min talk",
      medium: "~2-5 min for a 45-min talk",
      large:  "~10-20 min for a 45-min talk (most accurate)",
    };

    // Slide detection toggle
    const slideDetectToggle = $("#slide-detect");
    const slideOptions = $("#slide-options");
    slideDetectToggle.addEventListener("change", () => {
      slideOptions.classList.toggle("disabled", !slideDetectToggle.checked);
    });

    // Slider value display
    const thresholdInput = $("#threshold");
    const thresholdVal = $("#threshold-val");
    thresholdInput.addEventListener("input", () => {
      thresholdVal.textContent = parseFloat(thresholdInput.value).toFixed(2);
    });

    // Model hint
    const modelSelect = $("#model");
    modelSelect.addEventListener("change", () => {
      $("#model-hint").textContent = modelHints[modelSelect.value] || "";
    });

    // Toast
    function showToast(msg) {
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2000);
    }

    // Format transcript for display with highlighted slide markers
    function renderTranscript(text) {
      const area = $("#transcript-area");
      area.innerHTML = "";
      const lines = text.split("\n");
      for (const line of lines) {
        if (line.includes("--- SLIDE CHANGE ---")) {
          const span = document.createElement("span");
          span.className = "slide-marker";
          span.textContent = line;
          area.appendChild(span);
        } else {
          area.appendChild(document.createTextNode(line + "\n"));
        }
      }
    }

    // Main flow
    let rawTranscript = "";

    $("#btn-start").addEventListener("click", async () => {
      const url = $("#url").value.trim();
      if (!url) { showToast("Enter a video URL."); return; }

      const threshold = parseFloat(thresholdInput.value);
      const model = modelSelect.value;
      const detectSlides = slideDetectToggle.checked;

      // Disable button
      const btn = $("#btn-start");
      btn.disabled = true;
      btn.textContent = "RIPPING...";

      // Show progress, hide output
      const progressSection = $("#progress-section");
      const outputSection = $("#output-section");
      progressSection.classList.add("visible");
      outputSection.classList.remove("visible");
      $("#progress-log").innerHTML = "";
      $("#spinner").classList.remove("done");
      $("#check-mark").classList.remove("done");
      $("#progress-label").textContent = "Processing...";

      // Start the job
      try {
        const resp = await fetch("/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, threshold, model, detect_slides: detectSlides }),
        });
        if (!resp.ok) {
          const err = await resp.json();
          showToast(err.error || "Failed to start.");
          btn.disabled = false;
          btn.textContent = "RIP IT";
          return;
        }
      } catch (e) {
        showToast("Network error.");
        btn.disabled = false;
        btn.textContent = "RIP IT";
        return;
      }

      // Listen to SSE
      const es = new EventSource("/events");
      const log = $("#progress-log");

      function appendLog(msg, cls) {
        const div = document.createElement("div");
        div.className = "log-line" + (cls ? " " + cls : "");
        div.textContent = msg;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
      }

      es.addEventListener("progress", (e) => {
        appendLog(e.data);
        $("#progress-label").textContent = e.data;
      });

      es.addEventListener("done", async (e) => {
        appendLog(e.data, "log-done");
        es.close();
        $("#spinner").classList.add("done");
        $("#check-mark").classList.add("done");
        $("#progress-label").textContent = "Done!";
        btn.disabled = false;
        btn.textContent = "RIP IT";

        // Fetch result
        try {
          const r = await fetch("/result");
          if (r.ok) {
            const data = await r.json();
            rawTranscript = data.transcript;
            renderTranscript(rawTranscript);
            outputSection.classList.add("visible");
          }
        } catch (_) {}
      });

      es.addEventListener("error", (e) => {
        if (e.data) {
          appendLog(e.data, "log-error");
        }
        es.close();
        $("#spinner").classList.add("done");
        $("#progress-label").textContent = "Failed";
        btn.disabled = false;
        btn.textContent = "RIP IT";
      });

      es.onerror = () => {
        es.close();
        $("#spinner").classList.add("done");
        $("#progress-label").textContent = "Connection lost";
        btn.disabled = false;
        btn.textContent = "RIP IT";
      };
    });

    // Download
    $("#btn-download").addEventListener("click", () => {
      window.location.href = "/download";
    });

    // Copy
    $("#btn-copy").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(rawTranscript);
        showToast("Copied to clipboard!");
      } catch {
        showToast("Copy failed.");
      }
    });
  </script>
</body>
</html>
